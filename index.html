<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstraGPT - AI Assistant</title>

    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ececec;
            --text-secondary: #b4b4b4;
            --accent: #10a37f;
            --accent-hover: #0d8c6d;
            --border: #3a3a3a;
            --error: #ef4444;
            --sidebar-width: 260px;
            --artifacts-width: 400px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: var(--accent-hover);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .chat-item {
            padding: 0.75rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            group: hover;
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent);
        }

        .chat-item-title {
            flex: 1;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-actions {
            display: none;
            gap: 0.25rem;
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
        }

        .chat-item-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .chat-item-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-profile:hover {
            background: var(--bg-tertiary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Main Chat Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-header {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .header-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1.5rem;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .message {
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .avatar.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .avatar.ai {
            background: linear-gradient(135deg, var(--accent), #059669);
        }

        .message-content {
            margin-left: 2.75rem;
            line-height: 1.6;
        }

        .message-content pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
            position: relative;
        }

        .message-content code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .message-content p code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: white;
        }

        .input-container {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 1.5rem;
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .input-box {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 3.5rem 1rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.2s;
            min-height: 52px;
            max-height: 200px;
            font-family: inherit;
        }

        .input-box:focus {
            border-color: var(--accent);
        }

        .send-btn {
            position: absolute;
            right: 0.75rem;
            bottom: 0.75rem;
            background: var(--accent);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Artifacts Panel */
        .artifacts-panel {
            width: var(--artifacts-width);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .artifacts-panel.collapsed {
            transform: translateX(100%);
        }

        .artifacts-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .artifacts-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .close-artifacts {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.2rem;
        }

        .artifacts-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .artifact-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .artifact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .artifact-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .artifact-actions {
            display: flex;
            gap: 0.5rem;
        }

        .artifact-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .artifact-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .artifact-code {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 0.75rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 100;
            }

            .artifacts-panel {
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                z-index: 100;
            }

            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }

            .mobile-overlay.active {
                display: block;
            }
        }

        /* Hamburger Menu */
        .menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .empty-state h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent), #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .example-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .example-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .example-card h3 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .example-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Model Selector */
        .model-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        .model-selector:hover {
            border-color: var(--accent);
        }

        .model-selector:focus {
            border-color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewChat()">
                    <span>‚ûï</span>
                    <span>New Chat</span>
                </button>
            </div>

            <div class="chat-history" id="chatHistory">
                <!-- Chat items will be inserted here -->
            </div>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">U</div>
                    <div>
                        <div style="font-size: 0.9rem; font-weight: 600;">User</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Free Plan</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-area">
            <div class="chat-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <div class="chat-title" id="chatTitle">New Chat</div>
                    <select class="model-selector" id="modelSelector" onchange="handleModelChange()"
                        title="Select AI Model">
                        <option value="deepseek-coder:6.7b">AstraGPT-Coder-V1 (6.7B) ‚ö° Fast</option>
                        <option value="deepseek-coder-v2:16b">AstraGPT-Coder-V2 (16B) üöÄ Powerful</option>
                    </select>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="shareChat()">üîó Share</button>
                    <button class="header-btn" onclick="exportChat()">üì• Export</button>
                    <button class="header-btn" onclick="toggleArtifacts()">üìÑ Artifacts</button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="empty-state" id="emptyState">
                    <h1>Welcome to AstraGPT</h1>
                    <p>Your AI coding assistant powered by Tantra AI Labs</p>

                    <div class="example-prompts">
                        <div class="example-card" onclick="useExample('Write a Python function to reverse a string')">
                            <h3>üíª Code Generation</h3>
                            <p>Write a Python function</p>
                        </div>
                        <div class="example-card" onclick="useExample('Explain async/await in JavaScript')">
                            <h3>üìö Explanations</h3>
                            <p>Explain concepts</p>
                        </div>
                        <div class="example-card" onclick="useExample('Debug this code')">
                            <h3>üêõ Debugging</h3>
                            <p>Help fix errors</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea class="input-box" id="userInput" placeholder="Ask me anything..." rows="1"
                        onkeydown="handleKeyPress(event)" oninput="autoResize(this)"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Artifacts Panel -->
        <div class="artifacts-panel collapsed" id="artifactsPanel">
            <div class="artifacts-header">
                <div class="artifacts-title">üìÑ Artifacts</div>
                <button class="close-artifacts" onclick="toggleArtifacts()">√ó</button>
            </div>
            <div class="artifacts-content" id="artifactsContent">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    No artifacts yet. Code blocks will appear here.
                </div>
            </div>
        </div>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenus()"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <script>
        // State Management
        let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
        let currentConversationId = null;
        let isProcessing = false;
        let selectedModel = localStorage.getItem('selectedModel') || 'deepseek-coder:6.7b';

        // Configure marked.js
        marked.setOptions({
            highlight: function (code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                }
                return code;
            },
            breaks: true
        });

        // Initialize
        window.addEventListener('load', () => {
            // Load saved model preference
            document.getElementById('modelSelector').value = selectedModel;

            loadChatHistory();
            if (conversations.length === 0) {
                createNewChat();
            } else {
                loadConversation(conversations[0].id);
            }
        });

        // Model Selection Handler
        function handleModelChange() {
            const selector = document.getElementById('modelSelector');
            selectedModel = selector.value;
            localStorage.setItem('selectedModel', selectedModel);

            const modelName = selector.options[selector.selectedIndex].text;
            console.log('Model switched to:', modelName);
        }

        // Chat Management
        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString()
            };
            conversations.unshift(newChat);
            saveConversations();
            loadConversation(newChat.id);
            loadChatHistory();
        }

        function loadConversation(id) {
            currentConversationId = id;
            const conv = conversations.find(c => c.id === id);
            if (!conv) return;

            document.getElementById('chatTitle').textContent = conv.title;
            document.getElementById('chatMessages').innerHTML = '';

            if (conv.messages.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
                conv.messages.forEach(msg => {
                    addMessageToUI(msg.role, msg.content);
                });
            }

            updateChatHistoryUI();
        }

        function saveConversations() {
            localStorage.setItem('conversations', JSON.stringify(conversations));
        }

        function loadChatHistory() {
            const historyEl = document.getElementById('chatHistory');
            historyEl.innerHTML = conversations.map(conv => `
                <div class="chat-item ${conv.id === currentConversationId ? 'active' : ''}" 
                     onclick="loadConversation('${conv.id}')">
                    <div class="chat-item-title">${conv.title}</div>
                    <div class="chat-item-actions">
                        <button class="chat-item-btn" onclick="event.stopPropagation(); renameChat('${conv.id}')">‚úèÔ∏è</button>
                        <button class="chat-item-btn" onclick="event.stopPropagation(); deleteChat('${conv.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function updateChatHistoryUI() {
            loadChatHistory();
        }

        function renameChat(id) {
            const conv = conversations.find(c => c.id === id);
            const newTitle = prompt('Enter new title:', conv.title);
            if (newTitle && newTitle.trim()) {
                conv.title = newTitle.trim();
                saveConversations();
                if (id === currentConversationId) {
                    document.getElementById('chatTitle').textContent = newTitle;
                }
                loadChatHistory();
            }
        }

        function deleteChat(id) {
            if (!confirm('Delete this conversation?')) return;
            conversations = conversations.filter(c => c.id !== id);
            saveConversations();
            if (id === currentConversationId) {
                if (conversations.length > 0) {
                    loadConversation(conversations[0].id);
                } else {
                    createNewChat();
                }
            }
            loadChatHistory();
        }

        // UI Helpers
        function showEmptyState() {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.id = 'emptyState';
            empty.innerHTML = `
                <h1>Welcome to AstraGPT</h1>
                <p>Your AI coding assistant powered by Tantra AI Labs</p>
                <div class="example-prompts">
                    <div class="example-card" onclick="useExample('Write a Python function to reverse a string')">
                        <h3>üíª Code Generation</h3>
                        <p>Write a Python function</p>
                    </div>
                    <div class="example-card" onclick="useExample('Explain async/await in JavaScript')">
                        <h3>üìö Explanations</h3>
                        <p>Explain concepts</p>
                    </div>
                    <div class="example-card" onclick="useExample('Debug this code')">
                        <h3>üêõ Debugging</h3>
                        <p>Help fix errors</p>
                    </div>
                </div>
            `;
            document.getElementById('chatMessages').appendChild(empty);
        }

        function hideEmptyState() {
            const empty = document.getElementById('emptyState');
            if (empty) empty.remove();
        }

        function useExample(text) {
            document.getElementById('userInput').value = text;
            document.getElementById('userInput').focus();
            autoResize(document.getElementById('userInput'));
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Message Handling
        function addMessageToUI(role, content, isError = false) {
            hideEmptyState();
            const messagesEl = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
            const roleName = role === 'user' ? 'You' : 'AstraGPT';

            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="avatar ${role}">${avatar}</div>
                    <div style="font-weight: 600;">${roleName}</div>
                </div>
                <div class="message-content"></div>
            `;

            messagesEl.appendChild(messageDiv);
            const contentDiv = messageDiv.querySelector('.message-content');
            contentDiv.innerHTML = renderMarkdown(content);

            // Highlight code
            contentDiv.querySelectorAll('pre code').forEach(block => {
                Prism.highlightElement(block);
                extractArtifact(block);
            });

            messagesEl.scrollTop = messagesEl.scrollHeight;
            return contentDiv;
        }

        function renderMarkdown(text) {
            let html = marked.parse(text);
            html = html.replace(/<pre><code class="language-(\w+)">([\s\S]*?)<\/code><\/pre>/g,
                (match, lang, code) => {
                    return `<pre><code class="language-${lang}">${code}</code><button class="copy-btn" onclick="copyCode(this)">Copy</button></pre>`;
                }
            );
            return html;
        }

        function copyCode(btn) {
            const code = btn.previousElementSibling.textContent;
            navigator.clipboard.writeText(code).then(() => {
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }

        // Artifacts
        function extractArtifact(codeBlock) {
            const lang = codeBlock.className.match(/language-(\w+)/)?.[1] || 'text';
            const code = codeBlock.textContent;

            const artifactsContent = document.getElementById('artifactsContent');
            if (artifactsContent.children[0]?.textContent.includes('No artifacts')) {
                artifactsContent.innerHTML = '';
            }

            const artifactDiv = document.createElement('div');
            artifactDiv.className = 'artifact-item';
            artifactDiv.innerHTML = `
                <div class="artifact-header">
                    <div class="artifact-type">${lang.toUpperCase()}</div>
                    <div class="artifact-actions">
                        <button class="artifact-btn" onclick="copyArtifact(this)">Copy</button>
                        <button class="artifact-btn" onclick="downloadArtifact(this, '${lang}')">Download</button>
                    </div>
                </div>
                <div class="artifact-code"><code class="language-${lang}">${code}</code></div>
            `;

            artifactsContent.appendChild(artifactDiv);
            Prism.highlightElement(artifactDiv.querySelector('code'));
        }

        function copyArtifact(btn) {
            const code = btn.closest('.artifact-item').querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        function downloadArtifact(btn, lang) {
            const code = btn.closest('.artifact-item').querySelector('code').textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `code.${lang}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleArtifacts() {
            document.getElementById('artifactsPanel').classList.toggle('collapsed');
        }

        // API Configuration
        const API_URL = "https://58fd371f1449.ngrok-free.app/"; // Kaggle Ngrok URL

        // Chat Actions
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            document.getElementById('sendBtn').disabled = true;

            // Add to conversation
            const conv = conversations.find(c => c.id === currentConversationId);
            conv.messages.push({ role: 'user', content: message });

            // Update title if first message
            if (conv.messages.length === 1) {
                conv.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                document.getElementById('chatTitle').textContent = conv.title;
                updateChatHistoryUI();
            }

            addMessageToUI('user', message);
            input.value = '';
            autoResize(input);

            // Create placeholder for AI response
            const contentDiv = addMessageToUI('ai', '<span class="cursor">|</span>');
            let fullResponse = "";

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        message,
                        model_name: selectedModel,
                        user_id: 'web_user_' + Math.random().toString(36).substr(2, 9)
                    })
                });

                if (!response.ok) throw new Error('Server error: ' + response.statusText);

                const data = await response.json();
                fullResponse = data.response;

                if (data.blocked) {
                    fullResponse = `**Message Blocked:** ${data.reason}`;
                }

                // Update UI
                contentDiv.innerHTML = renderMarkdown(fullResponse);

                // Re-highlight code blocks
                contentDiv.querySelectorAll('pre code').forEach(block => {
                    Prism.highlightElement(block);
                });

                // Scroll to bottom
                const messagesEl = document.getElementById('chatMessages');
                messagesEl.scrollTop = messagesEl.scrollHeight;

                // Finalize
                conv.messages.push({ role: 'assistant', content: fullResponse });
                saveConversations();

            } catch (error) {
                contentDiv.innerHTML += `\n\n‚ùå Error: ${error.message}`;
                conv.messages.push({ role: 'assistant', content: fullResponse }); // Save what we got
            } finally {
                isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        function shareChat() {
            const conv = conversations.find(c => c.id === currentConversationId);
            const shareData = {
                title: conv.title,
                messages: conv.messages
            };
            const encoded = btoa(JSON.stringify(shareData));
            const url = `${window.location.origin}?share=${encoded}`;

            navigator.clipboard.writeText(url).then(() => {
                alert('Share link copied to clipboard!');
            });
        }

        function exportChat() {
            const conv = conversations.find(c => c.id === currentConversationId);
            const markdown = conv.messages.map(m =>
                `**${m.role === 'user' ? 'You' : 'AstraGPT'}:**\n${m.content}\n`
            ).join('\n---\n\n');

            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${conv.title}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('mobileOverlay').classList.toggle('active');
        }

        function closeMobileMenus() {
            document.getElementById('sidebar').classList.add('collapsed');
            document.getElementById('artifactsPanel').classList.add('collapsed');
            document.getElementById('mobileOverlay').classList.remove('active');
        }

        // Load shared chat
        const urlParams = new URLSearchParams(window.location.search);
        const sharedData = urlParams.get('share');
        if (sharedData) {
            try {
                const data = JSON.parse(atob(sharedData));
                const newChat = {
                    id: Date.now().toString(),
                    title: data.title + ' (Shared)',
                    messages: data.messages,
                    createdAt: new Date().toISOString()
                };
                conversations.unshift(newChat);
                saveConversations();
                loadConversation(newChat.id);
                loadChatHistory();
            } catch (e) {
                console.error('Invalid share link');
            }
        }
    </script>
</body>

</html>
